<!DOCTYPE html>
<html>
<head>
    <title>Cadence Sensor Reader</title>
</head>
<body>
    <button id="connectButton">Подключиться к датчику</button>
    <div id="cadenceData">Каденс: 0 об/мин</div>

    <script>
        const connectButton = document.getElementById('connectButton');
        const cadenceDisplay = document.getElementById('cadenceData');
        
        // UUID сервиса и характеристик
        const CSC_SERVICE_UUID = 0x1816;
        const CSC_MEASUREMENT_UUID = 0x2A5B;
        
        // Переменные для хранения предыдущих значений
        let lastCrankTime = 0;
        let lastCrankRevolutions = 0;

        connectButton.addEventListener('click', async () => {
            try {
                // Запрос подключения к устройству
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [CSC_SERVICE_UUID] }]
                });
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(CSC_SERVICE_UUID);
                const characteristic = await service.getCharacteristic(CSC_MEASUREMENT_UUID);
                
                // Подписка на уведомления
                await characteristic.startNotifications();
                
                // Обработка поступающих данных
                characteristic.addEventListener('characteristicvaluechanged', event => {
                    const value = event.target.value;
                    const flags = value.getUint8(0);
                    
                    // Проверяем наличие данных о каденсе
                    if (flags & 0x02) {
                        const crankRevolutions = value.getUint16(3, true);
                        const crankTime = value.getUint16(5, true);
                        
                        // Рассчет каденса
                        if (lastCrankTime !== 0) {
                            const timeDiff = (crankTime - lastCrankTime) / 1024; // в секундах
                            const revolutionDiff = crankRevolutions - lastCrankRevolutions;
                            
                            if (timeDiff > 0) {
                                const cadence = Math.round((revolutionDiff / timeDiff) * 60);
                                cadenceDisplay.textContent = `Каденс: ${cadence} об/мин`;
                            }
                        }
                        
                        // Сохраняем текущие значения
                        lastCrankTime = crankTime;
                        lastCrankRevolutions = crankRevolutions;
                    }
                });
                
                // Обработка отключения
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                connectButton.textContent = "Подключено";
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert(`Ошибка подключения: ${error}`);
            }
        });

        function onDisconnected() {
            connectButton.textContent = "Подключиться к датчику";
            cadenceDisplay.textContent = "Каденс: 0 об/мин";
            lastCrankTime = 0;
            lastCrankRevolutions = 0;
        }
    </script>
</body>
</html>
