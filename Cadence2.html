<!DOCTYPE html>
<html>
<head>
    <title>Cadence Sensor Debug</title>
    <style>
        .container { margin: 20px; font-family: Arial, sans-serif; }
        #debugLog { 
            height: 200px; 
            overflow-y: scroll; 
            border: 1px solid #ccc; 
            padding: 10px; 
            margin-top: 10px;
            background: #f8f8f8;
        }
        .data-section { margin: 15px 0; }
        .status { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <button id="connectButton">Подключиться к устройству</button>
        <div id="deviceInfo" class="data-section"></div>
        <div id="liveData" class="data-section"></div>
        <div id="debugLog"></div>
    </div>

    <script>
        const connectButton = document.getElementById('connectButton');
        const deviceInfo = document.getElementById('deviceInfo');
        const liveData = document.getElementById('liveData');
        const debugLog = document.getElementById('debugLog');

        let device = null;
        let server = null;
        let service = null;
        let characteristic = null;
        let updateInterval = null;

        // Конфигурация сервисов
        const CSC_SERVICE_UUID = 0x1816;
        const CSC_MEASUREMENT_UUID = 0x2A5B;
        const BATTERY_SERVICE_UUID = 0x180F;
        const BATTERY_LEVEL_UUID = 0x2A19;

        // Состояние устройства
        const deviceState = {
            connected: false,
            lastUpdate: null,
            cadence: 0,
            battery: 'N/A',
            rawData: [],
            debugMessages: []
        };

        // Логирование
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="time">[${timestamp}]</span> ${message}`;
            
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`, data || '');
        }

        // Основная функция подключения
        async function connectToDevice() {
            try {
                log('Инициализация подключения...');
                
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [CSC_SERVICE_UUID] }],
                    optionalServices: [BATTERY_SERVICE_UUID]
                });
                
                log(`Устройство выбрано: ${device.name}`, device);
                updateDeviceInfo('Устройство', device.name);

                log('Подключение к GATT серверу...');
                server = await device.gatt.connect();
                deviceState.connected = true;

                await updateServices();
                await setupNotifications();
                startMonitoring();

                log('Подключение успешно установлено');
                connectButton.textContent = "Отключиться";
                connectButton.onclick = disconnectDevice;

            } catch (error) {
                log(`Ошибка подключения: ${error}`);
                alert(`Ошибка: ${error}`);
            }
        }

        // Обновление информации о сервисах
        async function updateServices() {
            try {
                log('Поиск сервисов...');
                const services = await server.getPrimaryServices();
                
                services.forEach(async (service) => {
                    log(`Найден сервис: ${service.uuid}`);
                    const characteristics = await service.getCharacteristics();
                    characteristics.forEach(char => {
                        log(`Характеристика: ${char.uuid}`, {
                            properties: char.properties,
                            uuid: char.uuid
                        });
                    });
                });

                // Получение данных о батарее
                try {
                    const batteryService = await server.getPrimaryService(BATTERY_SERVICE_UUID);
                    const batteryChar = await batteryService.getCharacteristic(BATTERY_LEVEL_UUID);
                    const batteryValue = await batteryChar.readValue();
                    deviceState.battery = batteryValue.getUint8(0);
                    log(`Уровень заряда: ${deviceState.battery}%`);
                } catch (e) {
                    log('Данные о батарее недоступны');
                }

            } catch (error) {
                log(`Ошибка получения сервисов: ${error}`);
            }
        }

        // Настройка уведомлений
        async function setupNotifications() {
            try {
                service = await server.getPrimaryService(CSC_SERVICE_UUID);
                characteristic = await service.getCharacteristic(CSC_MEASUREMENT_UUID);
                
                await characteristic.startNotifications();
                log('Уведомления активированы');

                characteristic.addEventListener('characteristicvaluechanged', event => {
                    const value = event.target.value;
                    deviceState.rawData = Array.from(value.buffer);
                    log('Получены новые данные', {
                        rawBytes: deviceState.rawData,
                        timestamp: new Date().toISOString()
                    });
                    processCadenceData(value);
                });

            } catch (error) {
                log(`Ошибка настройки уведомлений: ${error}`);
            }
        }

        // Обработка данных каденса
        function processCadenceData(value) {
            try {
                const flags = value.getUint8(0);
                log(`Флаги данных: ${flags.toString(2).padStart(8, '0')}`);

                if (flags & 0x02) {
                    const crankRevolutions = value.getUint16(3, true);
                    const crankTime = value.getUint16(5, true);
                    
                    // Логирование сырых данных
                    log(`Параметры каденса: revolutions=${crankRevolutions}, time=${crankTime}`);

                    // Расчет каденса
                    if (deviceState.lastCrankTime && deviceState.lastCrankRevolutions !== undefined) {
                        const timeDiff = (crankTime - deviceState.lastCrankTime) / 1024;
                        const revolutionDiff = crankRevolutions - deviceState.lastCrankRevolutions;
                        
                        if (timeDiff > 0) {
                            deviceState.cadence = Math.round((revolutionDiff / timeDiff) * 60);
                            log(`Рассчитанный каденс: ${deviceState.cadence} об/мин`);
                        }
                    }

                    deviceState.lastCrankTime = crankTime;
                    deviceState.lastCrankRevolutions = crankRevolutions;
                }
                
                deviceState.lastUpdate = new Date();
                updateUI();

            } catch (error) {
                log(`Ошибка обработки данных: ${error}`);
            }
        }

        // Обновление интерфейса
        function updateUI() {
            liveData.innerHTML = `
                <div class="data-field">Текущий каденс: ${deviceState.cadence} об/мин</div>
                <div class="data-field">Уровень заряда: ${deviceState.battery}%</div>
                <div class="status">Последнее обновление: ${deviceState.lastUpdate?.toLocaleTimeString() || 'Нет данных'}</div>
            `;
        }

        // Запуск мониторинга
        function startMonitoring() {
            updateInterval = setInterval(() => {
                log('Проверка состояния подключения...');
                updateUI();
                
                if (!server.connected) {
                    log('Потеряно соединение с устройством');
                    disconnectDevice();
                }
            }, 1000);
        }

        // Отключение устройства
        async function disconnectDevice() {
            try {
                if (server?.connected) {
                    await server.disconnect();
                    log('Устройство отключено');
                }
            } catch (error) {
                log(`Ошибка отключения: ${error}`);
            }
            
            clearInterval(updateInterval);
            deviceState.connected = false;
            connectButton.textContent = "Подключиться к устройству";
            connectButton.onclick = connectToDevice;
            updateUI();
        }

        // Инициализация
        connectButton.addEventListener('click', connectToDevice);
        log('Система инициализирована. Готова к подключению.');
    </script>
</body>
</html>
